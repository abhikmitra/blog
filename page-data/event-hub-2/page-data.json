{"componentChunkName":"component---src-templates-blog-post-js","path":"/event-hub-2/","result":{"data":{"site":{"siteMetadata":{"title":"Abhik's Blog"}},"markdownRemark":{"id":"1667ba1b-dde6-5125-92dc-1a9162273d47","excerpt":"Azure Event Hub SDK Series This post is part 2 of a series of posts on Azure Event Hub SDK for Dot NET. Azure Event Hub SDK Internals - Part 1 (Overview…","html":"<h2>Azure Event Hub SDK Series</h2>\n<p>This post is <strong>part 2</strong> of a series of posts on Azure Event Hub SDK for Dot NET.</p>\n<ol>\n<li><a href=\"https://abhikmitra.github.io/blog/event-hub/\">Azure Event Hub SDK Internals - Part 1 (Overview &#x26; Control Flow)</a></li>\n<li><a href=\"https://abhikmitra.github.io/blog/event-hub-2/\">Azure Event Hub SDK Internals - Part 2 (Partition Manager &#x26; Lease Management)</a></li>\n<li><a href=\"https://abhikmitra.github.io/blog/event-hub-3/\">Azure Event Hub SDK Internals - Part 3 (Pumping Data &#x26; AMQP Links)</a></li>\n</ol>\n<p>Do you think there is more that I should cover or something I should fix ? Please raise an <a href=\"https://github.com/abhikmitra/blog/issues\">issue</a> and let me know.</p>\n<hr>\n<p>In this section we will deep dive into the <a href=\"https://github.com/Azure/azure-sdk-for-net/blob/5e30a0ca3873d54a310924925e35043dd9f3b6a0/sdk/eventhub/Microsoft.Azure.EventHubs.Processor/src/PartitionManager.cs\">Partition Manager</a> in the Event Hub SDK. This is the part that has some of the business logic of the receiver built-in. Partition Manager is responsible for initializing the stores and managing the leases of the partition.</p>\n<h2>Control Flow</h2>\n<p>The control flow in the Partition Manager can be divided into 2 distinct parts.</p>\n<ol>\n<li>Initialization Flow - In this flow partition managers initializes all the stores and get everything ready for receiving messages. This flow ends when the control flow is returned to <code class=\"language-text\">RegisterEventProcessorAsync</code>.</li>\n<li>RunAsync Flow - As the name suggests, this is an asynchronous &#x26; long-running operation that triggers the <code class=\"language-text\">SimpleEventProcessor</code> and make sure the processor keeps receiving the messages</li>\n</ol>\n<h3>Initialization flow</h3>\n<ul>\n<li>It initializes the stores. The Partition Manager checks if the lease-store and the checkpoint store exists.</li>\n<li>If they are not present it creates the appropriate Container in the Azure Blob Storage.</li>\n<li>Once the containers are created, we get the partition info from the event hub.</li>\n<li>Then we create <code class=\"language-text\">Leases</code> in the store. These are just blobs that have all the information needed to receive events.</li>\n<li>For each partition there will be 1 Lease Blobs.</li>\n<li>It also initializes the Checkpoint store and checkpoints which internally is the same as leases.</li>\n<li>In the current implementation a Checkpoint blob and the lease blob are one and same. The same blob represents both checkpoints and leases ownership.</li>\n</ul>\n<div class=\"mermaid\" data-processed=\"true\"><svg id=\"mermaid-1590513585653\" width=\"429.09375\" xmlns=\"http://www.w3.org/2000/svg\" height=\"322\" viewBox=\"0 0 429.09375 322\"><style>#mermaid-1590513585653 .label{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);color:#333}#mermaid-1590513585653 .label text{fill:#333}#mermaid-1590513585653 .node rect,#mermaid-1590513585653 .node circle,#mermaid-1590513585653 .node ellipse,#mermaid-1590513585653 .node polygon,#mermaid-1590513585653 .node path{fill:#ECECFF;stroke:#9370db;stroke-width:1px}#mermaid-1590513585653 .node .label{text-align:center}#mermaid-1590513585653 .node.clickable{cursor:pointer}#mermaid-1590513585653 .arrowheadPath{fill:#333}#mermaid-1590513585653 .edgePath .path{stroke:#333;stroke-width:1.5px}#mermaid-1590513585653 .edgeLabel{background-color:#e8e8e8;text-align:center}#mermaid-1590513585653 .cluster rect{fill:#ffffde;stroke:#aa3;stroke-width:1px}#mermaid-1590513585653 .cluster text{fill:#333}#mermaid-1590513585653 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:12px;background:#ffffde;border:1px solid #aa3;border-radius:2px;pointer-events:none;z-index:100}#mermaid-1590513585653 .actor{stroke:#ccf;fill:#ECECFF}#mermaid-1590513585653 text.actor{fill:#000;stroke:none}#mermaid-1590513585653 .actor-line{stroke:grey}#mermaid-1590513585653 .messageLine0{stroke-width:1.5;stroke-dasharray:'2 2';stroke:#333}#mermaid-1590513585653 .messageLine1{stroke-width:1.5;stroke-dasharray:'2 2';stroke:#333}#mermaid-1590513585653 #arrowhead{fill:#333}#mermaid-1590513585653 .sequenceNumber{fill:#fff}#mermaid-1590513585653 #sequencenumber{fill:#333}#mermaid-1590513585653 #crosshead path{fill:#333 !important;stroke:#333 !important}#mermaid-1590513585653 .messageText{fill:#333;stroke:none}#mermaid-1590513585653 .labelBox{stroke:#ccf;fill:#ECECFF}#mermaid-1590513585653 .labelText{fill:#000;stroke:none}#mermaid-1590513585653 .loopText{fill:#000;stroke:none}#mermaid-1590513585653 .loopLine{stroke-width:2;stroke-dasharray:'2 2';stroke:#ccf}#mermaid-1590513585653 .note{stroke:#aa3;fill:#fff5ad}#mermaid-1590513585653 .noteText{fill:black;stroke:none;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:14px}#mermaid-1590513585653 .activation0{fill:#f4f4f4;stroke:#666}#mermaid-1590513585653 .activation1{fill:#f4f4f4;stroke:#666}#mermaid-1590513585653 .activation2{fill:#f4f4f4;stroke:#666}#mermaid-1590513585653 .mermaid-main-font{font-family:\"trebuchet ms\", verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590513585653 .section{stroke:none;opacity:0.2}#mermaid-1590513585653 .section0{fill:rgba(102,102,255,0.49)}#mermaid-1590513585653 .section2{fill:#fff400}#mermaid-1590513585653 .section1,#mermaid-1590513585653 .section3{fill:#fff;opacity:0.2}#mermaid-1590513585653 .sectionTitle0{fill:#333}#mermaid-1590513585653 .sectionTitle1{fill:#333}#mermaid-1590513585653 .sectionTitle2{fill:#333}#mermaid-1590513585653 .sectionTitle3{fill:#333}#mermaid-1590513585653 .sectionTitle{text-anchor:start;font-size:11px;text-height:14px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590513585653 .grid .tick{stroke:#d3d3d3;opacity:0.8;shape-rendering:crispEdges}#mermaid-1590513585653 .grid .tick text{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590513585653 .grid path{stroke-width:0}#mermaid-1590513585653 .today{fill:none;stroke:red;stroke-width:2px}#mermaid-1590513585653 .task{stroke-width:2}#mermaid-1590513585653 .taskText{text-anchor:middle;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590513585653 .taskText:not([font-size]){font-size:11px}#mermaid-1590513585653 .taskTextOutsideRight{fill:#000;text-anchor:start;font-size:11px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590513585653 .taskTextOutsideLeft{fill:#000;text-anchor:end;font-size:11px}#mermaid-1590513585653 .task.clickable{cursor:pointer}#mermaid-1590513585653 .taskText.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-1590513585653 .taskTextOutsideLeft.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-1590513585653 .taskTextOutsideRight.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-1590513585653 .taskText0,#mermaid-1590513585653 .taskText1,#mermaid-1590513585653 .taskText2,#mermaid-1590513585653 .taskText3{fill:#fff}#mermaid-1590513585653 .task0,#mermaid-1590513585653 .task1,#mermaid-1590513585653 .task2,#mermaid-1590513585653 .task3{fill:#8a90dd;stroke:#534fbc}#mermaid-1590513585653 .taskTextOutside0,#mermaid-1590513585653 .taskTextOutside2{fill:#000}#mermaid-1590513585653 .taskTextOutside1,#mermaid-1590513585653 .taskTextOutside3{fill:#000}#mermaid-1590513585653 .active0,#mermaid-1590513585653 .active1,#mermaid-1590513585653 .active2,#mermaid-1590513585653 .active3{fill:#bfc7ff;stroke:#534fbc}#mermaid-1590513585653 .activeText0,#mermaid-1590513585653 .activeText1,#mermaid-1590513585653 .activeText2,#mermaid-1590513585653 .activeText3{fill:#000 !important}#mermaid-1590513585653 .done0,#mermaid-1590513585653 .done1,#mermaid-1590513585653 .done2,#mermaid-1590513585653 .done3{stroke:grey;fill:#d3d3d3;stroke-width:2}#mermaid-1590513585653 .doneText0,#mermaid-1590513585653 .doneText1,#mermaid-1590513585653 .doneText2,#mermaid-1590513585653 .doneText3{fill:#000 !important}#mermaid-1590513585653 .crit0,#mermaid-1590513585653 .crit1,#mermaid-1590513585653 .crit2,#mermaid-1590513585653 .crit3{stroke:#f88;fill:red;stroke-width:2}#mermaid-1590513585653 .activeCrit0,#mermaid-1590513585653 .activeCrit1,#mermaid-1590513585653 .activeCrit2,#mermaid-1590513585653 .activeCrit3{stroke:#f88;fill:#bfc7ff;stroke-width:2}#mermaid-1590513585653 .doneCrit0,#mermaid-1590513585653 .doneCrit1,#mermaid-1590513585653 .doneCrit2,#mermaid-1590513585653 .doneCrit3{stroke:#f88;fill:#d3d3d3;stroke-width:2;cursor:pointer;shape-rendering:crispEdges}#mermaid-1590513585653 .milestone{transform:rotate(45deg) scale(0.8, 0.8)}#mermaid-1590513585653 .milestoneText{font-style:italic}#mermaid-1590513585653 .doneCritText0,#mermaid-1590513585653 .doneCritText1,#mermaid-1590513585653 .doneCritText2,#mermaid-1590513585653 .doneCritText3{fill:#000 !important}#mermaid-1590513585653 .activeCritText0,#mermaid-1590513585653 .activeCritText1,#mermaid-1590513585653 .activeCritText2,#mermaid-1590513585653 .activeCritText3{fill:#000 !important}#mermaid-1590513585653 .titleText{text-anchor:middle;font-size:18px;fill:#000;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590513585653 g.classGroup text{fill:#9370db;stroke:none;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:10px}#mermaid-1590513585653 g.classGroup text .title{font-weight:bolder}#mermaid-1590513585653 g.clickable{cursor:pointer}#mermaid-1590513585653 g.classGroup rect{fill:#ECECFF;stroke:#9370db}#mermaid-1590513585653 g.classGroup line{stroke:#9370db;stroke-width:1}#mermaid-1590513585653 .classLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5}#mermaid-1590513585653 .classLabel .label{fill:#9370db;font-size:10px}#mermaid-1590513585653 .relation{stroke:#9370db;stroke-width:1;fill:none}#mermaid-1590513585653 .dashed-line{stroke-dasharray:3}#mermaid-1590513585653 #compositionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590513585653 #compositionEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590513585653 #aggregationStart{fill:#ECECFF;stroke:#9370db;stroke-width:1}#mermaid-1590513585653 #aggregationEnd{fill:#ECECFF;stroke:#9370db;stroke-width:1}#mermaid-1590513585653 #dependencyStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590513585653 #dependencyEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590513585653 #extensionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590513585653 #extensionEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1590513585653 .commit-id,#mermaid-1590513585653 .commit-msg,#mermaid-1590513585653 .branch-label{fill:lightgrey;color:lightgrey;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590513585653 .pieTitleText{text-anchor:middle;font-size:25px;fill:#000;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590513585653 .slice{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590513585653 g.stateGroup text{fill:#9370db;stroke:none;font-size:10px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1590513585653 g.stateGroup text{fill:#9370db;stroke:none;font-size:10px}#mermaid-1590513585653 g.stateGroup .state-title{font-weight:bolder;fill:#000}#mermaid-1590513585653 g.stateGroup rect{fill:#ECECFF;stroke:#9370db}#mermaid-1590513585653 g.stateGroup line{stroke:#9370db;stroke-width:1}#mermaid-1590513585653 .transition{stroke:#9370db;stroke-width:1;fill:none}#mermaid-1590513585653 .stateGroup .composit{fill:white;border-bottom:1px}#mermaid-1590513585653 .stateGroup .alt-composit{fill:#e0e0e0;border-bottom:1px}#mermaid-1590513585653 .state-note{stroke:#aa3;fill:#fff5ad}#mermaid-1590513585653 .state-note text{fill:black;stroke:none;font-size:10px}#mermaid-1590513585653 .stateLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5}#mermaid-1590513585653 .stateLabel text{fill:#000;font-size:10px;font-weight:bold;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}:root{--mermaid-font-family: '\"trebuchet ms\", verdana, arial';--mermaid-font-family: \"Comic Sans MS\", \"Comic Sans\", cursive}\n\n:root { --mermaid-font-family: \"trebuchet ms\", verdana, arial;}</style><style>#mermaid-1590513585653 {\n    color: rgb(0, 0, 0);\n    font: normal normal 400 normal 16px / normal \"trebuchet ms\", verdana, arial;\n  }</style><g transform=\"translate(0, 0)\"><g class=\"output\"><g class=\"clusters\"></g><g class=\"edgePaths\"><g class=\"edgePath\" style=\"opacity: 1;\"><path class=\"path\" d=\"M139.7890625,47L139.7890625,72L139.7890625,97\" marker-end=\"url(#arrowhead18)\" style=\"fill:none\"></path><defs><marker id=\"arrowhead18\" viewBox=\"0 0 10 10\" refX=\"9\" refY=\"5\" markerUnits=\"strokeWidth\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowheadPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker></defs></g><g class=\"edgePath\" style=\"opacity: 1;\"><path class=\"path\" d=\"M139.7890625,136L139.7890625,161L139.7890625,186\" marker-end=\"url(#arrowhead19)\" style=\"fill:none\"></path><defs><marker id=\"arrowhead19\" viewBox=\"0 0 10 10\" refX=\"9\" refY=\"5\" markerUnits=\"strokeWidth\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowheadPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker></defs></g><g class=\"edgePath\" style=\"opacity: 1;\"><path class=\"path\" d=\"M139.7890625,225L139.7890625,250L139.7890625,275\" marker-end=\"url(#arrowhead20)\" style=\"fill:none\"></path><defs><marker id=\"arrowhead20\" viewBox=\"0 0 10 10\" refX=\"9\" refY=\"5\" markerUnits=\"strokeWidth\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowheadPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker></defs></g><g class=\"edgePath\" style=\"opacity: 1;\"><path class=\"path\" d=\"M218.03125,284.81879471883934L297.3854166666667,275L317.2239583333333,275L337.0625,294.5L317.2239583333333,314L297.3854166666667,314L218.03125,304.18120528116066\" marker-end=\"url(#arrowhead21)\" style=\"fill:none\"></path><defs><marker id=\"arrowhead21\" viewBox=\"0 0 10 10\" refX=\"9\" refY=\"5\" markerUnits=\"strokeWidth\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowheadPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker></defs></g></g><g class=\"edgeLabels\"><g class=\"edgeLabel\" transform=\"\" style=\"opacity: 1;\"><g transform=\"translate(0,0)\" class=\"label\"><foreignObject width=\"0\" height=\"0\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: inline-block; white-space: nowrap;\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"\" style=\"opacity: 1;\"><g transform=\"translate(0,0)\" class=\"label\"><foreignObject width=\"0\" height=\"0\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: inline-block; white-space: nowrap;\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"\" style=\"opacity: 1;\"><g transform=\"translate(0,0)\" class=\"label\"><foreignObject width=\"0\" height=\"0\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: inline-block; white-space: nowrap;\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(337.0625,294.5)\" style=\"opacity: 1;\"><g transform=\"translate(-84.03125,-9.5)\" class=\"label\"><foreignObject width=\"168.0625\" height=\"19\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: inline-block; white-space: nowrap;\"><span class=\"edgeLabel\">loop for every partition</span></div></foreignObject></g></g></g><g class=\"nodes\"><g class=\"node default\" id=\"StartAsync\" transform=\"translate(139.7890625,27.5)\" style=\"opacity: 1;\"><rect rx=\"0\" ry=\"0\" x=\"-47.7421875\" y=\"-19.5\" width=\"95.484375\" height=\"39\" class=\"label-container\"></rect><g class=\"label\" transform=\"translate(0,0)\"><g transform=\"translate(-37.7421875,-9.5)\"><foreignObject width=\"75.484375\" height=\"19\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: inline-block; white-space: nowrap;\">StartAsync</div></foreignObject></g></g></g><g class=\"node default\" id=\"Initialize_Stores\" transform=\"translate(139.7890625,116.5)\" style=\"opacity: 1;\"><rect rx=\"0\" ry=\"0\" x=\"-67.5546875\" y=\"-19.5\" width=\"135.109375\" height=\"39\" class=\"label-container\"></rect><g class=\"label\" transform=\"translate(0,0)\"><g transform=\"translate(-57.5546875,-9.5)\"><foreignObject width=\"115.109375\" height=\"19\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: inline-block; white-space: nowrap;\">Initialize_Stores</div></foreignObject></g></g></g><g class=\"node default\" id=\"Get_PartitionIds_from_Event_Hub\" transform=\"translate(139.7890625,205.5)\" style=\"opacity: 1;\"><rect rx=\"0\" ry=\"0\" x=\"-131.7890625\" y=\"-19.5\" width=\"263.578125\" height=\"39\" class=\"label-container\"></rect><g class=\"label\" transform=\"translate(0,0)\"><g transform=\"translate(-121.7890625,-9.5)\"><foreignObject width=\"243.578125\" height=\"19\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: inline-block; white-space: nowrap;\">Get_PartitionIds_from_Event_Hub</div></foreignObject></g></g></g><g class=\"node default\" id=\"Create_Lease_Blob\" transform=\"translate(139.7890625,294.5)\" style=\"opacity: 1;\"><rect rx=\"0\" ry=\"0\" x=\"-78.2421875\" y=\"-19.5\" width=\"156.484375\" height=\"39\" class=\"label-container\"></rect><g class=\"label\" transform=\"translate(0,0)\"><g transform=\"translate(-68.2421875,-9.5)\"><foreignObject width=\"136.484375\" height=\"19\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: inline-block; white-space: nowrap;\">Create_Lease_Blob</div></foreignObject></g></g></g></g></g></g></svg></div>\n<h3>RunAsync Flow</h3>\n<ul>\n<li>\n<p>This flow keeps looping until cancellation is requested by calling UnregisterEventProcessorAsync.</p>\n<ul>\n<li>Renew owned Lease</li>\n<li>Check and Grab Expired/New Leases</li>\n<li>Steal leases if it is not load-balanced.</li>\n<li>Create or update pumps based on Leases.</li>\n</ul>\n</li>\n<li>In case there is an error or unregister has been called, it removes all the pumps.</li>\n</ul>\n<h2>Lease Management</h2>\n<p>This is the most interesting aspect of the SDK on how it manages the leases. To understand lease management, we  will divide it into 3 parts</p>\n<ol>\n<li>Check and Grab Expired/New Leases</li>\n<li>Renew owned Leases - Leases that are already owned by the current host</li>\n<li>Steal Leases</li>\n</ol>\n<p>To understand how leases work in Azure Blobs, it will be good to read this <a href=\"https://www.red-gate.com/simple-talk/cloud/platform-as-a-service/azure-blob-storage-part-8-blob-leases/\">article</a>. The leasing mechanism of event hub is built on Azure Blobs.\nSome of the points to remember are</p>\n<ul>\n<li>The lease on a blob can be acquired when the lease is in any state other than <code class=\"language-text\">Leased</code></li>\n<li>Once the Lease is acquired, the Azure blob SDK returns a token.</li>\n<li>This token is like a key, whoever possesses the token can operate on the blob.</li>\n<li>If one host gives their token to another host, the new host can call <code class=\"language-text\">ChangeLeaseAsync</code> to acquire a new lease for itself.</li>\n<li>The previous host loses the lease.</li>\n</ul>\n<h3>Grab expired leases</h3>\n<p>When we first start the Event hub Receiver and create the lease blobs. The leases have no owner. This part of the code is responsible for taking up expired as well as new leases.</p>\n<p>Get capacity of the host</p>\n<ul>\n<li>Before the Partition manager can start acquiring new leases it needs to check the ideal lease per host.</li>\n<li>It can figure out the active hosts by simply iterating over the lease blobs which are not expired.</li>\n<li>Then the ideal leaser host should be <code class=\"language-text\">number_of_lease_blob/number_of_active_hosts</code>. Let’s call this number <code class=\"language-text\">leaserPerHost</code></li>\n<li>Based on the existing leases that it already has, the number of leases the partition manager can own is <code class=\"language-text\">leaserPerHost-leasesWeAlreadyOwn</code>, lets call this number <code class=\"language-text\">targetLeaseCount</code></li>\n<li>If the <code class=\"language-text\">targetLeaseCount</code> is negative , its a no-operation. </li>\n</ul>\n<p>Grab Expired/New Leases</p>\n<ul>\n<li>\n<p>Partition Manager starts iterating through the lease blobs and whenever it finds any expired blobs</p>\n<ul>\n<li>It re-fetches the blobs to see its latest status.</li>\n<li>If the lease is not acquired by some other host</li>\n<li>It makes an <code class=\"language-text\">AcquireLeaseAsync</code> call on the lease blob. It passes a lease Id and the lease duration is set to 30 seconds.</li>\n<li>\n<p>Then it modifies the lease blob’s metadata. </p>\n<ul>\n<li>It the <code class=\"language-text\">OWNINGHOST</code> to the current host id in the metadata    </li>\n</ul>\n</li>\n<li>\n<p>It modifies the lease blob’s content. </p>\n<ul>\n<li>It sets the <code class=\"language-text\">Owner</code> to the current host id </li>\n<li>It sets the <code class=\"language-text\">Token</code> to the token returned by the Azure blob.</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>This entire process happens parallelly for the leases. As in if targetLeaseCount is 4, the code tries to get 4 leases parallelly.</li>\n<li>There is a possibility of race condition, so it re-queries the blob for its lease status. If the lease gets owned by some other host in between the code, it skips that lease and does not try to get access forcefully.</li>\n</ul>\n<h3>Renew leases</h3>\n<p>This part of the code deals with renewing leases for the leases which were already owned by the host. The code iterates through all the leases and figures out the ones that are owned by the current host.</p>\n<ul>\n<li>For each of the lease that is owned and not expired, Partition Manager queries the pumps to find an existing token.</li>\n<li>The token would mean that at some point we had the lease to the leaseBlob.While it is possible to query the leaseBlob text to get the token, getting it from in-memory guarantees that Partition Manager is not stealing some other Host’s lease.</li>\n<li>It uses the lease token to call into Azure Blob and renew the lease.</li>\n<li>If there is an exception, no retry is made. The in-memory lease array is marked appropriately to signify that the lease has been lost.</li>\n</ul>\n<h3>Steal Leases</h3>\n<p>This section only deals with leases that are owned by other hosts. If a leased blob does not have an owner, this section will not act on it.</p>\n<p>Finding a lease that can be stolen.</p>\n<ul>\n<li>We create a <code class=\"language-text\">countsByOwner</code> map, which has the count of leases per host</li>\n<li>We find the biggest owner who has the most number of leases.</li>\n<li>The <a href=\"https://github.com/Azure/azure-sdk-for-net/blob/5e30a0ca3873d54a310924925e35043dd9f3b6a0/sdk/eventhub/Microsoft.Azure.EventHubs.Processor/src/PartitionManager.cs#L641\">docs in the code</a> do a good job of explaining how the code decides which leases to still.</li>\n<li>\n<p>The most important line here is </p>\n<blockquote>\n<p>In either case, if the difference between this host and the biggest owner is 2 or more, then the system is not in the most evenly-distributed configuration, so steal one lease from the biggest.</p>\n</blockquote>\n</li>\n<li>So based on <code class=\"language-text\">(biggestOwner.Value - haveLeaseCount) &gt;= 2</code> we find <code class=\"language-text\">one</code> lease that we can move. This is <strong>not parallel</strong>, only one lease can be moved at a particular time.</li>\n</ul>\n<p>Once the above code finds a lease, it starts the process of stealing the lease. </p>\n<ul>\n<li>It checks if the lease was stolen by some other host. If it was stolen then we do no act on it.</li>\n<li>Refresh the lease and checks if it is not expired or ownership has already changed. as in the lease is stolen by someone else.</li>\n<li>Then we acquire the lease using the <strong>token that was present in the blob</strong>.</li>\n<li>The code calls into <code class=\"language-text\">ChangeLeaseAsync</code> using the token present in the blob to switch over the lease and generate a new token. </li>\n<li>The previous host now loses access to the lease.</li>\n</ul>\n<p>Now all of this lease management keeps happening in a loop until Cancellation is requested by calling into <code class=\"language-text\">Unregister</code>.</p>","frontmatter":{"title":"Azure Event Hub SDK Internals - Part 2 (Partition Manager & Lease Management)","date":"May 24, 2020","description":"In this post, we will deepdive into the partition Manager with a special focus on Lease Management"}}},"pageContext":{"slug":"/event-hub-2/","previous":{"fields":{"slug":"/event-hub/"},"frontmatter":{"title":"Azure Event Hub SDK Internals - Part 1 (Overview & Control Flow)"}},"next":{"fields":{"slug":"/event-hub-3/"},"frontmatter":{"title":"Azure Event Hub SDK Internals - Part 3 (Pumping Data & AMQP Link)"}}}}}