{"componentChunkName":"component---src-templates-blog-post-js","path":"/durable-task-4/","result":{"data":{"site":{"siteMetadata":{"title":"Abhik's Blog"}},"markdownRemark":{"id":"f52285d3-3bd9-5ae1-bd03-07d1f9ae9c57","excerpt":"Durable Task Framework Series This post is part 4 of a series of posts on DTF. Durable Task Framework Internals - Part 1 (Dataflow and Reliability) Durable Task…","html":"<h3>Durable Task Framework Series</h3>\n<p>This post is <strong>part 4</strong> of a series of posts on DTF.</p>\n<ol>\n<li><a href=\"https://abhikmitra.github.io/blog/durable-task/\">Durable Task Framework Internals - Part 1 (Dataflow and Reliability)</a></li>\n<li><a href=\"https://abhikmitra.github.io/blog/durable-task-2/\">Durable Task Framework Internals - Part 2 (The curious case of Orchestrations)</a></li>\n<li><a href=\"https://abhikmitra.github.io/blog/durable-task-3/\">Durable Task Framework Internals - Part 3 (Tracker Queue, Instance History, and JumpStart)</a></li>\n<li><a href=\"https://abhikmitra.github.io/blog/durable-task-4/\">Durable Task Framework Internals - Part 4 (Terminated Orchestrations &#x26; Middlewares)</a></li>\n<li><a href=\"https://abhikmitra.github.io/blog/durable-task-5/\">Durable Task Framework Internals - Part 5 (Interesting usages of TPL in DTF)</a></li>\n<li><a href=\"https://abhikmitra.github.io/blog/durable-task-5/\">Durable Task Framework Internals - Part 6 (Orchestration Execution Flow)</a></li>\n</ol>\n<p>Do you think there is more that I should cover or something I should fix ? Please raise an <a href=\"https://github.com/abhikmitra/blog/issues\">issue</a> and let me know.</p>\n<hr>\n<h3>Terminate an orchestration</h3>\n<p>The Client can control the orchestration even though the Hub manages the orchestration. The Client can issue <code class=\"language-text\">TerminateInstanceAsync</code> to terminate the ongoing orchestration.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-csharp line-numbers\"><code class=\"language-csharp\"><span class=\"token keyword\">var</span> instance <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">CreateOrchestrationInstanceAsync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span>TestOrchestration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"InstanceId5306\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Test Input\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Result<span class=\"token punctuation\">;</span>\nTask<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nclient<span class=\"token punctuation\">.</span><span class=\"token function\">TerminateInstanceAsync</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Here is the sequence diagram as to what happens behind the scenes</p>\n<div class=\"mermaid\" data-processed=\"true\"><svg id=\"mermaid-1587905562965\" width=\"100%\" xmlns=\"http://www.w3.org/2000/svg\" height=\"100%\" style=\"max-width:1250px;\" viewBox=\"-50 -10 1250 702\"><style>#mermaid-1587905562965 .label{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);color:#333}#mermaid-1587905562965 .label text{fill:#333}#mermaid-1587905562965 .node rect,#mermaid-1587905562965 .node circle,#mermaid-1587905562965 .node ellipse,#mermaid-1587905562965 .node polygon,#mermaid-1587905562965 .node path{fill:#ECECFF;stroke:#9370db;stroke-width:1px}#mermaid-1587905562965 .node .label{text-align:center}#mermaid-1587905562965 .node.clickable{cursor:pointer}#mermaid-1587905562965 .arrowheadPath{fill:#333}#mermaid-1587905562965 .edgePath .path{stroke:#333;stroke-width:1.5px}#mermaid-1587905562965 .edgeLabel{background-color:#e8e8e8;text-align:center}#mermaid-1587905562965 .cluster rect{fill:#ffffde;stroke:#aa3;stroke-width:1px}#mermaid-1587905562965 .cluster text{fill:#333}#mermaid-1587905562965 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:12px;background:#ffffde;border:1px solid #aa3;border-radius:2px;pointer-events:none;z-index:100}#mermaid-1587905562965 .actor{stroke:#ccf;fill:#ECECFF}#mermaid-1587905562965 text.actor{fill:#000;stroke:none}#mermaid-1587905562965 .actor-line{stroke:grey}#mermaid-1587905562965 .messageLine0{stroke-width:1.5;stroke-dasharray:'2 2';stroke:#333}#mermaid-1587905562965 .messageLine1{stroke-width:1.5;stroke-dasharray:'2 2';stroke:#333}#mermaid-1587905562965 #arrowhead{fill:#333}#mermaid-1587905562965 .sequenceNumber{fill:#fff}#mermaid-1587905562965 #sequencenumber{fill:#333}#mermaid-1587905562965 #crosshead path{fill:#333 !important;stroke:#333 !important}#mermaid-1587905562965 .messageText{fill:#333;stroke:none}#mermaid-1587905562965 .labelBox{stroke:#ccf;fill:#ECECFF}#mermaid-1587905562965 .labelText{fill:#000;stroke:none}#mermaid-1587905562965 .loopText{fill:#000;stroke:none}#mermaid-1587905562965 .loopLine{stroke-width:2;stroke-dasharray:'2 2';stroke:#ccf}#mermaid-1587905562965 .note{stroke:#aa3;fill:#fff5ad}#mermaid-1587905562965 .noteText{fill:black;stroke:none;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:14px}#mermaid-1587905562965 .activation0{fill:#f4f4f4;stroke:#666}#mermaid-1587905562965 .activation1{fill:#f4f4f4;stroke:#666}#mermaid-1587905562965 .activation2{fill:#f4f4f4;stroke:#666}#mermaid-1587905562965 .mermaid-main-font{font-family:\"trebuchet ms\", verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 .section{stroke:none;opacity:0.2}#mermaid-1587905562965 .section0{fill:rgba(102,102,255,0.49)}#mermaid-1587905562965 .section2{fill:#fff400}#mermaid-1587905562965 .section1,#mermaid-1587905562965 .section3{fill:#fff;opacity:0.2}#mermaid-1587905562965 .sectionTitle0{fill:#333}#mermaid-1587905562965 .sectionTitle1{fill:#333}#mermaid-1587905562965 .sectionTitle2{fill:#333}#mermaid-1587905562965 .sectionTitle3{fill:#333}#mermaid-1587905562965 .sectionTitle{text-anchor:start;font-size:11px;text-height:14px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 .grid .tick{stroke:#d3d3d3;opacity:0.8;shape-rendering:crispEdges}#mermaid-1587905562965 .grid .tick text{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 .grid path{stroke-width:0}#mermaid-1587905562965 .today{fill:none;stroke:red;stroke-width:2px}#mermaid-1587905562965 .task{stroke-width:2}#mermaid-1587905562965 .taskText{text-anchor:middle;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 .taskText:not([font-size]){font-size:11px}#mermaid-1587905562965 .taskTextOutsideRight{fill:#000;text-anchor:start;font-size:11px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 .taskTextOutsideLeft{fill:#000;text-anchor:end;font-size:11px}#mermaid-1587905562965 .task.clickable{cursor:pointer}#mermaid-1587905562965 .taskText.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-1587905562965 .taskTextOutsideLeft.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-1587905562965 .taskTextOutsideRight.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-1587905562965 .taskText0,#mermaid-1587905562965 .taskText1,#mermaid-1587905562965 .taskText2,#mermaid-1587905562965 .taskText3{fill:#fff}#mermaid-1587905562965 .task0,#mermaid-1587905562965 .task1,#mermaid-1587905562965 .task2,#mermaid-1587905562965 .task3{fill:#8a90dd;stroke:#534fbc}#mermaid-1587905562965 .taskTextOutside0,#mermaid-1587905562965 .taskTextOutside2{fill:#000}#mermaid-1587905562965 .taskTextOutside1,#mermaid-1587905562965 .taskTextOutside3{fill:#000}#mermaid-1587905562965 .active0,#mermaid-1587905562965 .active1,#mermaid-1587905562965 .active2,#mermaid-1587905562965 .active3{fill:#bfc7ff;stroke:#534fbc}#mermaid-1587905562965 .activeText0,#mermaid-1587905562965 .activeText1,#mermaid-1587905562965 .activeText2,#mermaid-1587905562965 .activeText3{fill:#000 !important}#mermaid-1587905562965 .done0,#mermaid-1587905562965 .done1,#mermaid-1587905562965 .done2,#mermaid-1587905562965 .done3{stroke:grey;fill:#d3d3d3;stroke-width:2}#mermaid-1587905562965 .doneText0,#mermaid-1587905562965 .doneText1,#mermaid-1587905562965 .doneText2,#mermaid-1587905562965 .doneText3{fill:#000 !important}#mermaid-1587905562965 .crit0,#mermaid-1587905562965 .crit1,#mermaid-1587905562965 .crit2,#mermaid-1587905562965 .crit3{stroke:#f88;fill:red;stroke-width:2}#mermaid-1587905562965 .activeCrit0,#mermaid-1587905562965 .activeCrit1,#mermaid-1587905562965 .activeCrit2,#mermaid-1587905562965 .activeCrit3{stroke:#f88;fill:#bfc7ff;stroke-width:2}#mermaid-1587905562965 .doneCrit0,#mermaid-1587905562965 .doneCrit1,#mermaid-1587905562965 .doneCrit2,#mermaid-1587905562965 .doneCrit3{stroke:#f88;fill:#d3d3d3;stroke-width:2;cursor:pointer;shape-rendering:crispEdges}#mermaid-1587905562965 .milestone{transform:rotate(45deg) scale(0.8, 0.8)}#mermaid-1587905562965 .milestoneText{font-style:italic}#mermaid-1587905562965 .doneCritText0,#mermaid-1587905562965 .doneCritText1,#mermaid-1587905562965 .doneCritText2,#mermaid-1587905562965 .doneCritText3{fill:#000 !important}#mermaid-1587905562965 .activeCritText0,#mermaid-1587905562965 .activeCritText1,#mermaid-1587905562965 .activeCritText2,#mermaid-1587905562965 .activeCritText3{fill:#000 !important}#mermaid-1587905562965 .titleText{text-anchor:middle;font-size:18px;fill:#000;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 g.classGroup text{fill:#9370db;stroke:none;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:10px}#mermaid-1587905562965 g.classGroup text .title{font-weight:bolder}#mermaid-1587905562965 g.clickable{cursor:pointer}#mermaid-1587905562965 g.classGroup rect{fill:#ECECFF;stroke:#9370db}#mermaid-1587905562965 g.classGroup line{stroke:#9370db;stroke-width:1}#mermaid-1587905562965 .classLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5}#mermaid-1587905562965 .classLabel .label{fill:#9370db;font-size:10px}#mermaid-1587905562965 .relation{stroke:#9370db;stroke-width:1;fill:none}#mermaid-1587905562965 .dashed-line{stroke-dasharray:3}#mermaid-1587905562965 #compositionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 #compositionEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 #aggregationStart{fill:#ECECFF;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 #aggregationEnd{fill:#ECECFF;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 #dependencyStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 #dependencyEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 #extensionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 #extensionEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 .commit-id,#mermaid-1587905562965 .commit-msg,#mermaid-1587905562965 .branch-label{fill:lightgrey;color:lightgrey;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 .pieTitleText{text-anchor:middle;font-size:25px;fill:#000;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 .slice{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 g.stateGroup text{fill:#9370db;stroke:none;font-size:10px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 g.stateGroup text{fill:#9370db;stroke:none;font-size:10px}#mermaid-1587905562965 g.stateGroup .state-title{font-weight:bolder;fill:#000}#mermaid-1587905562965 g.stateGroup rect{fill:#ECECFF;stroke:#9370db}#mermaid-1587905562965 g.stateGroup line{stroke:#9370db;stroke-width:1}#mermaid-1587905562965 .transition{stroke:#9370db;stroke-width:1;fill:none}#mermaid-1587905562965 .stateGroup .composit{fill:white;border-bottom:1px}#mermaid-1587905562965 .stateGroup .alt-composit{fill:#e0e0e0;border-bottom:1px}#mermaid-1587905562965 .state-note{stroke:#aa3;fill:#fff5ad}#mermaid-1587905562965 .state-note text{fill:black;stroke:none;font-size:10px}#mermaid-1587905562965 .stateLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5}#mermaid-1587905562965 .stateLabel text{fill:#000;font-size:10px;font-weight:bold;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}:root{--mermaid-font-family: '\"trebuchet ms\", verdana, arial';--mermaid-font-family: \"Comic Sans MS\", \"Comic Sans\", cursive}\n\n:root { --mermaid-font-family: \"trebuchet ms\", verdana, arial;}</style><style>#mermaid-1587905562965 {\n    color: rgb(0, 0, 0);\n    font: normal normal 400 normal 16px / normal \"trebuchet ms\", verdana, arial;\n  }</style><g></g><g><line id=\"actor0\" x1=\"75\" y1=\"5\" x2=\"75\" y2=\"691\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"0\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"75\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"75\" dy=\"0\">Client</tspan></text></g><g><line id=\"actor1\" x1=\"275\" y1=\"5\" x2=\"275\" y2=\"691\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"200\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"275\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"275\" dy=\"0\">Orchestrator</tspan></text></g><g><line id=\"actor2\" x1=\"475\" y1=\"5\" x2=\"475\" y2=\"691\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"400\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"475\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"475\" dy=\"0\">Hub</tspan></text></g><g><line id=\"actor3\" x1=\"675\" y1=\"5\" x2=\"675\" y2=\"691\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"600\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"675\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"675\" dy=\"0\">TestOrchestration</tspan></text></g><g><line id=\"actor4\" x1=\"875\" y1=\"5\" x2=\"875\" y2=\"691\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"800\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"875\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"875\" dy=\"0\">Worker</tspan></text></g><g><line id=\"actor5\" x1=\"1075\" y1=\"5\" x2=\"1075\" y2=\"691\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"1000\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"1075\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"1075\" dy=\"0\">TaskActivity</tspan></text></g><defs><marker id=\"arrowhead\" refX=\"5\" refY=\"2\" markerWidth=\"6\" markerHeight=\"4\" orient=\"auto\"><path d=\"M 0,0 V 4 L6,2 Z\"></path></marker></defs><defs><marker id=\"crosshead\" markerWidth=\"15\" markerHeight=\"8\" orient=\"auto\" refX=\"16\" refY=\"4\"><path fill=\"black\" stroke=\"#000000\" stroke-width=\"1px\" d=\"M 9,2 V 6 L16,4 Z\" style=\"stroke-dasharray: 0, 0;\"></path><path fill=\"none\" stroke=\"#000000\" stroke-width=\"1px\" d=\"M 0,1 L 6,7 M 6,1 L 0,7\" style=\"stroke-dasharray: 0, 0;\"></path></marker></defs><defs><marker id=\"sequencenumber\" refX=\"15\" refY=\"15\" markerWidth=\"60\" markerHeight=\"40\" orient=\"auto\"><circle cx=\"15\" cy=\"15\" r=\"6\"></circle></marker></defs><g><text x=\"175\" y=\"93\" class=\"messageText\" style=\"text-anchor: middle;\">ExecutionStarted</text><line x1=\"75\" y1=\"100\" x2=\"275\" y2=\"100\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"375\" y=\"128\" class=\"messageText\" style=\"text-anchor: middle;\">ExecutionStarted</text><line x1=\"275\" y1=\"135\" x2=\"475\" y2=\"135\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"575\" y=\"163\" class=\"messageText\" style=\"text-anchor: middle;\">Orchestration Invoked</text><line x1=\"475\" y1=\"170\" x2=\"675\" y2=\"170\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><text x=\"675\" y=\"198\" class=\"messageText\" style=\"text-anchor: middle;\">TaskScheduled</text><line x1=\"475\" y1=\"205\" x2=\"875\" y2=\"205\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"675\" y=\"233\" class=\"messageText\" style=\"text-anchor: middle;\">Task Scheduled</text><line x1=\"875\" y1=\"240\" x2=\"475\" y2=\"240\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"775\" y=\"268\" class=\"messageText\" style=\"text-anchor: middle;\">Task Invoked</text><line x1=\"475\" y1=\"275\" x2=\"1075\" y2=\"275\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><rect x=\"1070\" y=\"277\" fill=\"#EDF2AE\" stroke=\"#666\" width=\"10\" height=\"200\" rx=\"0\" ry=\"0\" class=\"activation0\"></rect></g><g><rect x=\"0\" y=\"285\" fill=\"#EDF2AE\" stroke=\"#666\" width=\"150\" height=\"52\" rx=\"0\" ry=\"0\" class=\"note\"></rect><text x=\"-4\" y=\"309\" class=\"noteText\"><tspan x=\"16\">After 5 seconds of </tspan></text><text x=\"-4\" y=\"325\" class=\"noteText\"><tspan x=\"16\"> waiting</tspan></text></g><g><text x=\"175\" y=\"365\" class=\"messageText\" style=\"text-anchor: middle;\">ExecutionTerminated</text><line x1=\"75\" y1=\"372\" x2=\"275\" y2=\"372\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"375\" y=\"400\" class=\"messageText\" style=\"text-anchor: middle;\">ExecutionTerminated</text><line x1=\"275\" y1=\"407\" x2=\"475\" y2=\"407\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"375\" y=\"435\" class=\"messageText\" style=\"text-anchor: middle;\">TaskCompleted</text><line x1=\"475\" y1=\"442\" x2=\"275\" y2=\"442\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><text x=\"772.5\" y=\"470\" class=\"messageText\" style=\"text-anchor: middle;\">Task Finished</text><line x1=\"1070\" y1=\"477\" x2=\"475\" y2=\"477\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><text x=\"375\" y=\"505\" class=\"messageText\" style=\"text-anchor: middle;\">TaskCompleted</text><line x1=\"275\" y1=\"512\" x2=\"475\" y2=\"512\" class=\"messageLine1\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"stroke-dasharray: 3, 3; fill: none;\"></line></g><g><rect x=\"400\" y=\"522\" fill=\"#EDF2AE\" stroke=\"#666\" width=\"150\" height=\"84\" rx=\"0\" ry=\"0\" class=\"note\"></rect><text x=\"396\" y=\"546\" class=\"noteText\"><tspan x=\"416\">Since the </tspan></text><text x=\"396\" y=\"562\" class=\"noteText\"><tspan x=\"416\"> orchestration is</tspan></text><text x=\"396\" y=\"578\" class=\"noteText\"><tspan x=\"416\"> already terminated </tspan></text><text x=\"396\" y=\"594\" class=\"noteText\"><tspan x=\"416\"> - No-Op</tspan></text></g><g><rect x=\"0\" y=\"626\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"75\" y=\"658.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"75\" dy=\"0\">Client</tspan></text></g><g><rect x=\"200\" y=\"626\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"275\" y=\"658.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"275\" dy=\"0\">Orchestrator</tspan></text></g><g><rect x=\"400\" y=\"626\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"475\" y=\"658.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"475\" dy=\"0\">Hub</tspan></text></g><g><rect x=\"600\" y=\"626\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"675\" y=\"658.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"675\" dy=\"0\">TestOrchestration</tspan></text></g><g><rect x=\"800\" y=\"626\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"875\" y=\"658.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"875\" dy=\"0\">Worker</tspan></text></g><g><rect x=\"1000\" y=\"626\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"1075\" y=\"658.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"1075\" dy=\"0\">TaskActivity</tspan></text></g></svg></div>\n<p>So the terminate request is again sent as a message in the queue. The orchestrator gets the event and puts it in the session state.\nWhenever the Hub receives an event, it checks its existing list of old events from the session state and builds up the current state.\nSo whenever the next set of TaskCompletion events, it will all result in a No-Op. The termination is asynchronous. There isn’t any facility to cancel ongoing TaskActivities, and only new ones will not be triggered.</p>\n<h3>Activity Middlewares</h3>\n<p>The DTF Framework supports middlewares for plugging into the Activity and Orchestration execution flow. They are pretty simple to solve it and works how you would expect any middlewares to work.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-csharp line-numbers\"><code class=\"language-csharp\">hubWorker<span class=\"token punctuation\">.</span><span class=\"token function\">AddActivityDispatcherMiddleware</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> activity <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetProperty</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TaskActivity</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> instance <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetProperty</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrchestrationInstance</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Activity Details - \"</span> <span class=\"token operator\">+</span> activity<span class=\"token punctuation\">.</span><span class=\"token function\">GetType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" Id = \"</span> <span class=\"token operator\">+</span> instance<span class=\"token punctuation\">.</span>InstanceId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The delegate that you pass to <code class=\"language-text\">AddActivityDispatcherMiddleware</code> is invoked just before the TaskActivity gets invoked</p>\n<div class=\"mermaid\" data-processed=\"true\"><svg id=\"mermaid-1587905562965\" width=\"100%\" xmlns=\"http://www.w3.org/2000/svg\" height=\"100%\" style=\"max-width:650px;\" viewBox=\"-50 -10 650 344\"><style>#mermaid-1587905562965 .label{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);color:#333}#mermaid-1587905562965 .label text{fill:#333}#mermaid-1587905562965 .node rect,#mermaid-1587905562965 .node circle,#mermaid-1587905562965 .node ellipse,#mermaid-1587905562965 .node polygon,#mermaid-1587905562965 .node path{fill:#ECECFF;stroke:#9370db;stroke-width:1px}#mermaid-1587905562965 .node .label{text-align:center}#mermaid-1587905562965 .node.clickable{cursor:pointer}#mermaid-1587905562965 .arrowheadPath{fill:#333}#mermaid-1587905562965 .edgePath .path{stroke:#333;stroke-width:1.5px}#mermaid-1587905562965 .edgeLabel{background-color:#e8e8e8;text-align:center}#mermaid-1587905562965 .cluster rect{fill:#ffffde;stroke:#aa3;stroke-width:1px}#mermaid-1587905562965 .cluster text{fill:#333}#mermaid-1587905562965 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:12px;background:#ffffde;border:1px solid #aa3;border-radius:2px;pointer-events:none;z-index:100}#mermaid-1587905562965 .actor{stroke:#ccf;fill:#ECECFF}#mermaid-1587905562965 text.actor{fill:#000;stroke:none}#mermaid-1587905562965 .actor-line{stroke:grey}#mermaid-1587905562965 .messageLine0{stroke-width:1.5;stroke-dasharray:'2 2';stroke:#333}#mermaid-1587905562965 .messageLine1{stroke-width:1.5;stroke-dasharray:'2 2';stroke:#333}#mermaid-1587905562965 #arrowhead{fill:#333}#mermaid-1587905562965 .sequenceNumber{fill:#fff}#mermaid-1587905562965 #sequencenumber{fill:#333}#mermaid-1587905562965 #crosshead path{fill:#333 !important;stroke:#333 !important}#mermaid-1587905562965 .messageText{fill:#333;stroke:none}#mermaid-1587905562965 .labelBox{stroke:#ccf;fill:#ECECFF}#mermaid-1587905562965 .labelText{fill:#000;stroke:none}#mermaid-1587905562965 .loopText{fill:#000;stroke:none}#mermaid-1587905562965 .loopLine{stroke-width:2;stroke-dasharray:'2 2';stroke:#ccf}#mermaid-1587905562965 .note{stroke:#aa3;fill:#fff5ad}#mermaid-1587905562965 .noteText{fill:black;stroke:none;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:14px}#mermaid-1587905562965 .activation0{fill:#f4f4f4;stroke:#666}#mermaid-1587905562965 .activation1{fill:#f4f4f4;stroke:#666}#mermaid-1587905562965 .activation2{fill:#f4f4f4;stroke:#666}#mermaid-1587905562965 .mermaid-main-font{font-family:\"trebuchet ms\", verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 .section{stroke:none;opacity:0.2}#mermaid-1587905562965 .section0{fill:rgba(102,102,255,0.49)}#mermaid-1587905562965 .section2{fill:#fff400}#mermaid-1587905562965 .section1,#mermaid-1587905562965 .section3{fill:#fff;opacity:0.2}#mermaid-1587905562965 .sectionTitle0{fill:#333}#mermaid-1587905562965 .sectionTitle1{fill:#333}#mermaid-1587905562965 .sectionTitle2{fill:#333}#mermaid-1587905562965 .sectionTitle3{fill:#333}#mermaid-1587905562965 .sectionTitle{text-anchor:start;font-size:11px;text-height:14px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 .grid .tick{stroke:#d3d3d3;opacity:0.8;shape-rendering:crispEdges}#mermaid-1587905562965 .grid .tick text{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 .grid path{stroke-width:0}#mermaid-1587905562965 .today{fill:none;stroke:red;stroke-width:2px}#mermaid-1587905562965 .task{stroke-width:2}#mermaid-1587905562965 .taskText{text-anchor:middle;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 .taskText:not([font-size]){font-size:11px}#mermaid-1587905562965 .taskTextOutsideRight{fill:#000;text-anchor:start;font-size:11px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 .taskTextOutsideLeft{fill:#000;text-anchor:end;font-size:11px}#mermaid-1587905562965 .task.clickable{cursor:pointer}#mermaid-1587905562965 .taskText.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-1587905562965 .taskTextOutsideLeft.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-1587905562965 .taskTextOutsideRight.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-1587905562965 .taskText0,#mermaid-1587905562965 .taskText1,#mermaid-1587905562965 .taskText2,#mermaid-1587905562965 .taskText3{fill:#fff}#mermaid-1587905562965 .task0,#mermaid-1587905562965 .task1,#mermaid-1587905562965 .task2,#mermaid-1587905562965 .task3{fill:#8a90dd;stroke:#534fbc}#mermaid-1587905562965 .taskTextOutside0,#mermaid-1587905562965 .taskTextOutside2{fill:#000}#mermaid-1587905562965 .taskTextOutside1,#mermaid-1587905562965 .taskTextOutside3{fill:#000}#mermaid-1587905562965 .active0,#mermaid-1587905562965 .active1,#mermaid-1587905562965 .active2,#mermaid-1587905562965 .active3{fill:#bfc7ff;stroke:#534fbc}#mermaid-1587905562965 .activeText0,#mermaid-1587905562965 .activeText1,#mermaid-1587905562965 .activeText2,#mermaid-1587905562965 .activeText3{fill:#000 !important}#mermaid-1587905562965 .done0,#mermaid-1587905562965 .done1,#mermaid-1587905562965 .done2,#mermaid-1587905562965 .done3{stroke:grey;fill:#d3d3d3;stroke-width:2}#mermaid-1587905562965 .doneText0,#mermaid-1587905562965 .doneText1,#mermaid-1587905562965 .doneText2,#mermaid-1587905562965 .doneText3{fill:#000 !important}#mermaid-1587905562965 .crit0,#mermaid-1587905562965 .crit1,#mermaid-1587905562965 .crit2,#mermaid-1587905562965 .crit3{stroke:#f88;fill:red;stroke-width:2}#mermaid-1587905562965 .activeCrit0,#mermaid-1587905562965 .activeCrit1,#mermaid-1587905562965 .activeCrit2,#mermaid-1587905562965 .activeCrit3{stroke:#f88;fill:#bfc7ff;stroke-width:2}#mermaid-1587905562965 .doneCrit0,#mermaid-1587905562965 .doneCrit1,#mermaid-1587905562965 .doneCrit2,#mermaid-1587905562965 .doneCrit3{stroke:#f88;fill:#d3d3d3;stroke-width:2;cursor:pointer;shape-rendering:crispEdges}#mermaid-1587905562965 .milestone{transform:rotate(45deg) scale(0.8, 0.8)}#mermaid-1587905562965 .milestoneText{font-style:italic}#mermaid-1587905562965 .doneCritText0,#mermaid-1587905562965 .doneCritText1,#mermaid-1587905562965 .doneCritText2,#mermaid-1587905562965 .doneCritText3{fill:#000 !important}#mermaid-1587905562965 .activeCritText0,#mermaid-1587905562965 .activeCritText1,#mermaid-1587905562965 .activeCritText2,#mermaid-1587905562965 .activeCritText3{fill:#000 !important}#mermaid-1587905562965 .titleText{text-anchor:middle;font-size:18px;fill:#000;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 g.classGroup text{fill:#9370db;stroke:none;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:10px}#mermaid-1587905562965 g.classGroup text .title{font-weight:bolder}#mermaid-1587905562965 g.clickable{cursor:pointer}#mermaid-1587905562965 g.classGroup rect{fill:#ECECFF;stroke:#9370db}#mermaid-1587905562965 g.classGroup line{stroke:#9370db;stroke-width:1}#mermaid-1587905562965 .classLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5}#mermaid-1587905562965 .classLabel .label{fill:#9370db;font-size:10px}#mermaid-1587905562965 .relation{stroke:#9370db;stroke-width:1;fill:none}#mermaid-1587905562965 .dashed-line{stroke-dasharray:3}#mermaid-1587905562965 #compositionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 #compositionEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 #aggregationStart{fill:#ECECFF;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 #aggregationEnd{fill:#ECECFF;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 #dependencyStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 #dependencyEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 #extensionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 #extensionEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1587905562965 .commit-id,#mermaid-1587905562965 .commit-msg,#mermaid-1587905562965 .branch-label{fill:lightgrey;color:lightgrey;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 .pieTitleText{text-anchor:middle;font-size:25px;fill:#000;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 .slice{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 g.stateGroup text{fill:#9370db;stroke:none;font-size:10px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-1587905562965 g.stateGroup text{fill:#9370db;stroke:none;font-size:10px}#mermaid-1587905562965 g.stateGroup .state-title{font-weight:bolder;fill:#000}#mermaid-1587905562965 g.stateGroup rect{fill:#ECECFF;stroke:#9370db}#mermaid-1587905562965 g.stateGroup line{stroke:#9370db;stroke-width:1}#mermaid-1587905562965 .transition{stroke:#9370db;stroke-width:1;fill:none}#mermaid-1587905562965 .stateGroup .composit{fill:white;border-bottom:1px}#mermaid-1587905562965 .stateGroup .alt-composit{fill:#e0e0e0;border-bottom:1px}#mermaid-1587905562965 .state-note{stroke:#aa3;fill:#fff5ad}#mermaid-1587905562965 .state-note text{fill:black;stroke:none;font-size:10px}#mermaid-1587905562965 .stateLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5}#mermaid-1587905562965 .stateLabel text{fill:#000;font-size:10px;font-weight:bold;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}:root{--mermaid-font-family: '\"trebuchet ms\", verdana, arial';--mermaid-font-family: \"Comic Sans MS\", \"Comic Sans\", cursive}\n\n:root { --mermaid-font-family: \"trebuchet ms\", verdana, arial;}</style><style>#mermaid-1587905562965 {\n    color: rgb(0, 0, 0);\n    font: normal normal 400 normal 16px / normal \"trebuchet ms\", verdana, arial;\n  }</style><g></g><g><line id=\"actor0\" x1=\"75\" y1=\"5\" x2=\"75\" y2=\"333\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"0\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"75\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"75\" dy=\"0\">Hub</tspan></text></g><g><line id=\"actor1\" x1=\"275\" y1=\"5\" x2=\"275\" y2=\"333\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"200\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"275\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"275\" dy=\"0\">Middleware</tspan></text></g><g><line id=\"actor2\" x1=\"475\" y1=\"5\" x2=\"475\" y2=\"333\" class=\"actor-line\" stroke-width=\"0.5px\" stroke=\"#999\"></line><rect x=\"400\" y=\"0\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"475\" y=\"32.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"475\" dy=\"0\">TaskActivity</tspan></text></g><defs><marker id=\"arrowhead\" refX=\"5\" refY=\"2\" markerWidth=\"6\" markerHeight=\"4\" orient=\"auto\"><path d=\"M 0,0 V 4 L6,2 Z\"></path></marker></defs><defs><marker id=\"crosshead\" markerWidth=\"15\" markerHeight=\"8\" orient=\"auto\" refX=\"16\" refY=\"4\"><path fill=\"black\" stroke=\"#000000\" stroke-width=\"1px\" d=\"M 9,2 V 6 L16,4 Z\" style=\"stroke-dasharray: 0, 0;\"></path><path fill=\"none\" stroke=\"#000000\" stroke-width=\"1px\" d=\"M 0,1 L 6,7 M 6,1 L 0,7\" style=\"stroke-dasharray: 0, 0;\"></path></marker></defs><defs><marker id=\"sequencenumber\" refX=\"15\" refY=\"15\" markerWidth=\"60\" markerHeight=\"40\" orient=\"auto\"><circle cx=\"15\" cy=\"15\" r=\"6\"></circle></marker></defs><g><rect x=\"0\" y=\"75\" fill=\"#EDF2AE\" stroke=\"#666\" width=\"150\" height=\"68\" rx=\"0\" ry=\"0\" class=\"note\"></rect><text x=\"-4\" y=\"99\" class=\"noteText\"><tspan x=\"16\">Hub receives </tspan></text><text x=\"-4\" y=\"115\" class=\"noteText\"><tspan x=\"16\"> the TaskScheduled </tspan></text><text x=\"-4\" y=\"131\" class=\"noteText\"><tspan x=\"16\"> event</tspan></text></g><g><text x=\"175\" y=\"171\" class=\"messageText\" style=\"text-anchor: middle;\">Middleware Invoked</text><line x1=\"75\" y1=\"178\" x2=\"275\" y2=\"178\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><text x=\"175\" y=\"206\" class=\"messageText\" style=\"text-anchor: middle;\">Middleware Execution Complete</text><line x1=\"275\" y1=\"213\" x2=\"75\" y2=\"213\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><text x=\"275\" y=\"241\" class=\"messageText\" style=\"text-anchor: middle;\">Task Invoked</text><line x1=\"75\" y1=\"248\" x2=\"475\" y2=\"248\" class=\"messageLine0\" stroke-width=\"2\" stroke=\"black\" marker-end=\"url(#arrowhead)\" style=\"fill: none;\"></line></g><g><rect x=\"0\" y=\"268\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"75\" y=\"300.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"75\" dy=\"0\">Hub</tspan></text></g><g><rect x=\"200\" y=\"268\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"275\" y=\"300.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"275\" dy=\"0\">Middleware</tspan></text></g><g><rect x=\"400\" y=\"268\" fill=\"#eaeaea\" stroke=\"#666\" width=\"150\" height=\"65\" rx=\"3\" ry=\"3\" class=\"actor\"></rect><text x=\"475\" y=\"300.5\" dominant-baseline=\"central\" alignment-baseline=\"central\" class=\"actor\" style=\"text-anchor: middle; font-size: 14px;\"><tspan x=\"475\" dy=\"0\">TaskActivity</tspan></text></g></svg></div>\n<p>The middlewares get invoked in the same thread as Tasks, and they individually do not have any reliability. There is no state marker to show middleware was run successfully, but the Task failed. Middlewares get invoked for all tasks irrespective if the Task had failed in its previous run or not. It is agnostic to the Task triggering the middleware.</p>\n<p>Also, the middleware cannot be used to handle task failures. You cannot put a try-catch around the <code class=\"language-text\">next()</code> call. The Exceptions thrown by the Task are caught and swallowed by the framework in the <em>TaskActivityDispatcher</em> part of the code, and the middlewares do not receive it.</p>\n<h4>Potential Gotcha!</h4>\n<p>Middlewares, if they fail, will fail the Task as well. Interestingly , such failures <strong>do not trigger the <code class=\"language-text\">TaskFailed</code> event</strong>. But since the TaskScheduled message is not removed from the queue, the Hub keeps retrying and gives up when the limit is reached. Since the TaskFailed event was not generated, Azure Table Storage would also not show that the Task had failed. </p>\n<p>Here is an example when one task completes, and others fail due to a failure in the middleware. <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/91116b4a7188b097891bc8fc56884dd4/96658/TableStore.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA+ElEQVQY002NTU4CQRCF57puDHHjDTyEpyCjiTsTVAwrB4IYEzNdXdXd8wcCbgRWz+p2MmHx8l79fZXdzn5x/XDC1f0Rl7nqrld+VueHvn8a5iPdvxgfcfN4QNOs0XRb1O03suKrwWzl8LxgPC0EL0unzpgUlPJkbjF990mxjv66Cpgufdoryg3mnxZvHwRT7ZE1dQUvDLEGjkmzhZBJipmpROUl5eh1cAiO4XS/1nrTtRBmkDH42SswhBrWMkqjH8gOuSzN0DPqLA7MonIpi/Np1nbr4Wa7i8CqgtUP8YgisM//MqlHRD1MIAqLAO9D8i4C+5udAv8ATixg3fcEHYUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Store\"\n        title=\"Store\"\n        src=\"/blog/static/91116b4a7188b097891bc8fc56884dd4/fcda8/TableStore.png\"\n        srcset=\"/blog/static/91116b4a7188b097891bc8fc56884dd4/12f09/TableStore.png 148w,\n/blog/static/91116b4a7188b097891bc8fc56884dd4/e4a3f/TableStore.png 295w,\n/blog/static/91116b4a7188b097891bc8fc56884dd4/fcda8/TableStore.png 590w,\n/blog/static/91116b4a7188b097891bc8fc56884dd4/96658/TableStore.png 881w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span> </p>\n<p>The store has all the data about <em>Task1</em> till it was scheduled. One would be excused for thinking that <em>Task1</em> was never picked up, and there is something wrong with DTF.</p>\n<p>What happened was, our middleware threw an exception when it was run in the context of <em>Task1</em>, but in other cases, it passed. Hence there is no data for <em>Task1</em> failing. This behavior is something to keep in mind when debugging the failures.</p>\n<h3>Orchestration Middlewares</h3>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-csharp line-numbers\"><code class=\"language-csharp\"> hubWorker<span class=\"token punctuation\">.</span><span class=\"token function\">AddOrchestrationDispatcherMiddleware</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> orchestration <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetProperty</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TaskOrchestration</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> state <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetProperty</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrchestrationRuntimeState</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> instance <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetProperty</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrchestrationInstance</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n   orchestration Details - \"</span> <span class=\"token operator\">+</span> orchestration<span class=\"token punctuation\">.</span><span class=\"token function\">GetType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" Id = \"</span> <span class=\"token operator\">+</span> instance<span class=\"token punctuation\">.</span>InstanceId <span class=\"token operator\">+</span> <span class=\"token string\">\"state = \"</span> <span class=\"token operator\">+</span> state<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">.</span>Count <span class=\"token operator\">+</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Orchestration Middlewares work and behave the same way as the TaskActivity middlewares. The middleware gets invoked <em>each time</em> the orchestration gets invoked. Similar to activity middlewares a try-catch would not be able to catch exceptions from Orchestrations.</p>","frontmatter":{"title":"Durable Task Framework Internals - Part 4 (Terminated Orchestrations & Middlewares)","date":"April 26, 2020","description":"In this part we look at how the framework handles cancellations and middlewares"}}},"pageContext":{"slug":"/durable-task-4/","previous":{"fields":{"slug":"/durable-task-3/"},"frontmatter":{"title":"Durable Task Framework Internals - Part 3 (Tracker Queue, Instance History, and JumpStart)"}},"next":{"fields":{"slug":"/durable-task-5/"},"frontmatter":{"title":"Durable Task Framework Internals - Part 5 (Interesting usages of TPL in DTF)"}}}}}